<!DOCTYPE html>
<html>
  <head>
      <base target="_top">
      <meta charset="UTF-8">
      <title>Wreath Webform</title>
      <link rel="shortcut icon" href="#">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  </head>

  <style>
      body {
        max-width: 100%;
        background-color: #F7F6EF;
        font-family: Geneva, 'Lucida Grande', 'Lucida Sans Unicode', serif;
      }

      input[type=text]not(.other_name) {
        border-radius: 3px;
        border: none;
        height: 18px;
      }

      /* Chrome, Safari, Edge, Opera */
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      /* Firefox */
      input[type=number] {
        -moz-appearance: textfield;
      }

      select {
        appearance: none;
        background-color: white;
        background-image: url(data:image/svg+xml,%3Csvg%20width%3D%2280px%22%20height%3D%2280px%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Cpath%20d%3D%22M5.70711%209.71069C5.31658%2010.1012%205.31658%2010.7344%205.70711%2011.1249L10.5993%2016.0123C11.3805%2016.7927%2012.6463%2016.7924%2013.4271%2016.0117L18.3174%2011.1213C18.708%2010.7308%2018.708%2010.0976%2018.3174%209.70708C17.9269%209.31655%2017.2937%209.31655%2016.9032%209.70708L12.7176%2013.8927C12.3271%2014.2833%2011.6939%2014.2832%2011.3034%2013.8927L7.12132%209.71069C6.7308%209.32016%206.09763%209.32016%205.70711%209.71069Z%22%20fill%3D%22%230F0F0F%22%2F%3E%0A%3C%2Fsvg%3E);
        background-repeat: no-repeat;
        background-position: right;
        background-size: 25px;
        min-width: 3.5em;
        height: 2em;
        padding: 2px;
        border-radius: 5px;
        padding: 1px;
        padding-left: 3px;
      }

      .indent {
        margin-left: 1em;
      }

      .wreath_item_select{
          width: 80%;
          min-width: 15.5em;
          height: 2em;
        }

      .scout_name_select{
        min-width: 13em;
        margin-bottom: 10px;
        background-color: lightgrey;
        border: transparent;
      }

      .container {
        max-width: 95%;
        margin: auto;
      }

      #webform_title{
        font-family: Geneva, 'Lucida Grande', 'Lucida Sans Unicode', serif;
      }

      .cust_payment>label {
        margin-right: -6px;
      }

      .cust_payment>input {
        margin-right: 10px;

      }

      .tab {
        overflow: hidden;
        display: flex;
        position: sticky;
        top: 0;
        width: 80%;
        padding: 0 2em 0 1em;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        border-radius: 5px;
        z-index: 100;

      }

      .tab_spaces {
        display: inline-block;
        margin-left: 40px;
      }

      /* Style the buttons inside the tab */
      .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 28px;
        transition: 0.3s;
        font-size: 17px;
        font-family: Geneva, 'Lucida Grande', 'Lucida Sans Unicode', serif;
      }

      /* Change background color of buttons on hover */
      .tab button:hover {
        background-color: #ddd;
      }

      /* Create an active/current tablink class */
      .tab button.active {
        background-color: #ccc;
      }

      /* Style the tab content */
      .tabcontent {
        display: none;
        padding: 6px 6px;
        /*animation: fadeEffect 1s;*/
      }

      .name_email_section {
        overflow: hidden;
        display: flex;
        justify-content: start;
        gap: 14px;
      }

      .btn1, .btn2, .btn3 {
        background-color: #4CAF50;
        align-items: center;
        background-clip: padding-box;
        border: 1px solid transparent;
        border-radius: 8px;
        box-shadow: rgba(0, 0, 0, 0.02) 0 1px 3px 0;
        box-sizing: border-box;
        color: #fff;
        cursor: pointer;
        display: inline-flex;
        font-size: 16px;
        justify-content: center;
        line-height: 1.25;
        padding: 5px;
        position: relative;
        margin-left: 5px;
      }

      .btn2 {
        background-color: #008CBA;
      }

      .btn1:hover, .btn2:hover, .btn3:hover {
        background-color: #00ace6;
        box-shadow: rgba(0, 0, 0, 0.1) 0 4px 12px;
      }

      .btn1:active, .btn2:active, .btn3:active {
        background-color: #0086b3;
        box-shadow: rgba(0, 0, 0, .06) 0 2px 4px;
      }

      .btn3 {
        z-index: 1;
        font-size: 10px;
      }

      #totals {
        margin-top: 5px;
        margin-bottom: 3px;
      }

      .spacing1 {
        padding: 0 0 16px 0;
      }

      .tab_info {
        max-width: 60em;
        font-family: Geneva, 'Lucida Grande', 'Lucida Sans Unicode', serif;
        font-size: 16px;
      }

      .all_data_table{
        font-family: Arial, Helvetica, sans-serif;
        font-size: 12px;
        border-collapse: collapse;
        width: 100%;
      }

      .all_data_table tbody {
        width: 100%;
      }

      .all_data_table tr:nth-child(2n+1) {
        background-color: azure;
      }

      .all_data_table tr:hover {background-color: #ddd;}

      .all_data_table th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: center;
        background-color: #75c0e0;
        color: white;
      }

      .all_data_table tr {
        text-align: center;
      }

      .all_data_table td {
        position: relative;
        text-align: center;

      }

      .table_item_left {
        text-align: left !important;
      } 

      .table_cell_note:hover {
        cursor: pointer;
      }

      .local_orders_info, .gift_shipper_info {
        display: none;
      }

      .comment_div{
        position: absolute;
        top: 0;
        right: 0;
        width: 0px;
        height: 0px;
        border: 10px solid;
        border-width: 10px 0 0 10px;
        border-color: orange transparent transparent transparent;
      }

      .cust_info{
        display: flex;
        flex-flow: column;
        width: 27em;
        gap: 7px;
        padding: 0.5em 1em 0.5em 1em;
        margin-left: 3em;
        background: #ADD8E6;
        border-radius: 5px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
      }

      .cust_info_item {
        display: flex;
        flex-flow: row;
        align-items: center;
        gap: 8px;
      }

      .cust_info_item label {
        White-space: nowrap;
      }

      .section_titles {
        display: flex;
        flex-flow: column;
        padding: 0 0 0 0;
      }

      @keyframes fadeEffect {
        from {opacity: 0;}
        to {opacity: 1;}
      }

      .data_section{
        display: flex;
        flex-direction: column;
      }

      .add_item{
        display: flex;
        flex-flow: row nowrap;
        align-items: center;
        justify-content: start;
        gap: 13px;
        padding: 0.5em 1em 1em 0em;
      }

      .add_item_column {
        display: flex;
        flex-flow: column;
        border-radius: 5px;
        padding: 1em 1em 1em 1em;
        background: #FF8C00;
        width: 36em;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
      }
      
      .wreath_line {
        display: flex;
        flex-flow: row nowrap;
        align-items: center;
        gap: 13px;

       }

       .wreath_info {
         width: 35em;
         padding: 1em 0 0 0;
       }

       .wreath_donation_amt{
          display: none;
        }

      .single_entry{
        display: flex;
        flex-flow: column;
        padding: 1px 0 0 0;
      }
      .header1 {
        padding: 1em 0 0 0;
        margin-bottom: -10px;
      }

      .add_item_svg:hover {
        color: #FF8C00;
      }

      .single_entry_bottom {
        overflow: hidden;
        display: flex;
        position: sticky;
        bottom: 0;
        justify-content: space-between;
        align-items: center;
        width: 50%;
        padding: 0.5em 2em 0.5em 1em;
        background: #f1f1f160;
        border: 1px solid #ccc;
        border-radius: 5px;

      }

      .popup {
        max-width: 100%;
        max-height: 100%;
        position: fixed;
        z-index: 1101;
        left: 50%;
        top: 50%;
        border-radius: 8px;
        margin: auto;
        transform: translate(-50%, -50%);
        transition: opacity 400ms ease-in;
        background: #F7F6EF;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
      }

      .popup_overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1100;

        opacity: 0.4;
        background-color: rgba(0,0,0,0.5);
      }

      .popup_content {
        margin: 10px;

      }

      .popup_button {
        position: absolute;
        top: -16px;
        right: -16px;
        background-color: teal;
        border: 1px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        color: #fff;
        padding: 3px;
      }

      .clickable_span{
        color: blue;
      }

      .clickable_span:hover {
        cursor: pointer;

      }

      .show_info_link {
        display: none;
      }

      .all_data_div {
        display: none;
      }

      .loader {
        display: none;
        position: fixed;
        z-index: 1101;
        left: 50%;
        top: 50%;
        border: 16px solid #f3f3f3;
        border-top: 16px solid #304d24;
        border-bottom: 16px solid #304d24;
        border-radius: 50%;
	      margin: auto;
        margin-left: -7vw;
        width: 70px;
        height: 70px;
        transform: translate(-50%, -50%);
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      #cust_addr, #cust_note, #cust_email {
        flex-grow: 2;
      }

      .btn4 {
        margin-right: -10px;
        border-radius: 4px;
        border-width: 1px;
      }

      .avoidwrap {
        display: flex;
        flex-flow: row;
        gap: 10px;
        align-content: center;
        align-items: center;
      }

      .totals_class {
        border-top: 1px dashed;
      }

      @media (max-width: 800px)  {

        body {
          padding-bottom: 160px;
        }

        .container {
          max-width: 100%;
          margin: auto;

        }

        .popup {
          width: 70vw;
        }

        .cust_info_item {
          width: 99%;
        }

        #cust_addr, #cust_note, #cust_email {
          width: auto;
          max-width: 80%;
      }

        .wreath_info {
          width: 100%;
        }

        .wreath_line{
          flex-flow: row wrap;
        }

        .wreath_info{
          display: none;
        }

        .order_divs {
          display: flex;
          margin: 1em 0 1em 0;
          padding: 1em 1em 1em 1em;
          background-color: lightblue;
          border-radius: 5px;
          flex-direction: column;
          box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
          width: 80vw;
        }

        #my_orders_section {
          font-size: 14px;
        }

        #email_address {
          width: auto;
        }

        .email_div {
          display: flex;
          flex-flow: row;
          align-items: center;
          width: 100%;
          gap: 8px;
          margin-top: -8px;
        }

        .order_divs:nth-child(2n+1){
          background-color: lightcyan;
        }

        .all_data_div {
          display: inline-block;
        }

        .show_info_link {
          display: inline-block;
        }

        .all_data_table {
          display: none;
        }

        .local_orders_info, .gift_shipper_info {
          display: flex;
          margin-top: 5px;
          margin-bottom: 0px;
          font-weight: bold;
        }

        #cust_note {
          width: 80%;
        }

        .tab {
          width: 100%;
          padding: 0 0 0 0;
        }

        .tab_info {
          font-size: 15px;
        }

        .single_entry_bottom {
          width: 100%;
          padding: 0.25em 0 0.25em 0;
	        margin-bottom: 2em;

        }

        .cust_info{
          width: calc(100% - 10px);
          column-gap: 2px;
          row-gap: 5px;
          padding: 0.5em 0.5em 0.5em 0.5em;
          margin-left: 0px;
          background: #ADD8E6;
          border-radius: 5px;
          font-size: 14px;
        }

        .add_item{
          gap: 3px;
          padding: 0.5em 0 0.5em 0;
        }

        .add_item_column {
          padding: 0.5em 0.5em 0.5em 0.5em;
          max-width: 90%;
        }

        .add_item_svg {
          margin-left: -8px;
        }

        .wreath_line {
          gap: 4px 20px;
        }

        .wreath_info_small {
          display: flex;
          flex-flow: row;
          gap: 8px;
          margin-top: 3px;
        }
        .tab button {
          font-size: 15px;
        }

        .avoidwrap {
          display: flex;
          flex-flow: row;
          align-items: center;
        }

        .wreath_item_select{
          width: 80%;
          min-width: 15.5em;
        }

        .btn4 {
          margin-right: -8px;
        }

      }


  </style>
  <body>
    <div class="container" id="container" onclick="container_click()">
      <center><h1 id="webform_title"></h1></center>
      <div class="spacing1">
        <div class="name_email_section">
          <span>
            <label for="scoutname">Scout Name: </label>
              <select name="scoutname" id="scoutname" class="scout_name_select" onchange="toggle_name(this)"></select>
          </span>
          <span id="display_other_name" style="display: none;">
            <label for="other_name">Enter Name: </label>
              <input id="other_name" type="text" class="other_name" name="other_name">
          </span> 
        </div>
        <br>
        <div class="email_div">
          <label for="email_address" class="email_label">Your Email: </label>
          <input id="email_address" type="email" name="email_address" placeholder="required">
          <span class="clickable_span" onclick="show_email_info()">[info]</span>
        </div>
      </div>

      <div class="tab">
        <button id="enter_order_button" class="tablinks" onclick="openTab(event, 'single_entry_section')">Enter Order</button>
    <!--     <button class="tablinks" onclick="openTab(event, 'multi_order_section')">Multi Order</button> -->
        <button class="tablinks" onclick="openTab(event, 'my_orders_section')">My Orders</button>
        <button class="tablinks" onclick="openTab(event, 'info_section')">Info</button>
      </div>

      <div id="single_entry_section" class="tabcontent">
        <p id="single_entry_info" class="tab_info"></p>
        <div class="section_titles">
          <span>Customer contact info:</span>
        </div>
        <div class="cust_info">
          <div class="cust_info_item">
            <label for="cust_name">Name: </label>
            <input id="cust_name" type="text" name="cust_name" placeholder="required">
          </div>

          <div class="cust_info_item">
            <label for="cust_addr">Address: </label>
            <input id="cust_addr" type="text" name="cust_addr" placeholder="optional">
            <button type="button" id="geo_loc" class="btn4" onclick="geo_loc()" name="geo_loc">GPS</button>
          </div>

          <div class="cust_info_item">
            <label for="cust_phone">Phone if known: </label>
            <input id="cust_phone" type="tel" name="cust_phone" style="width: 10em;" onInput="this.value = phoneFormat(this.value)" placeholder="optional">
          </div>

          <div class="cust_info_item">
            <label for="cust_email">Email address to get a receipt: </label>
            <input id="cust_email" type="text" name="cust_email" style="width: 10em;" placeholder="optional">
          </div>

          <div class="cust_info_item">
            <label for="cust_note">Add note to order? </label>
            <input id="cust_note" type="text" name="cust_note" placeholder="optional">
            <!-- 
            <button type="button" id="paid" class="btn4" onclick="paid_button()" name="paid">Paid?</button>
            -->
          </div>
          <div class="cust_payment">
            <span>Payment:  </span>
            <label for="cust_cash">Cash</label>
            <input type="checkbox" id="cust_cash" name="cust_cash" value="cust_cash" onchange="toggle_checkbox(this)">
            <label for="cust_check">Check</label>
            <input type="checkbox" id="cust_check" name="cust_check" value="cust_check" onchange="toggle_checkbox(this)">
            <label for="cust_venmo">Venmo</label>
            <input type="checkbox" id="cust_venmo" name="cust_venmo" value="cust_venmo" onchange="toggle_checkbox(this)">
            <label for="cust_unpaid">Unpaid</label>
            <input type="checkbox" id="cust_unpaid" name="cust_unpaid" value="cust_unpaid" onchange="toggle_checkbox(this)">
          </div>

        </div>

        <div class="single_entry">
            <span class="header1">Enter customer order:</span>
          <div class="single_entry">
            <div id="wreath_section" class="wreath_section"></div>
          </div>
          <div class="single_entry_bottom">
            <div class="single_entry_buttons">
              <button type="button" id="save_all" class="btn1" onclick="save_data()" name="Submit_data">Submit</button>
              <button type="button" id="clear_all" class="btn2" onclick="clear_data()" name="clear_data">Clear All</button>
            </div>
            <div class="avoidwrap">
              <strong>Total: </strong> <span id="single_entry_total">$0</span>
            </div>
          </div>
        </div>

      </div>
<!--
      <div id="multi_order_section" class="tabcontent">
        <p id="multi_order_info"></p>
      </div>
-->

      <div id="my_orders_section" class="tabcontent">
        <p id="my_orders_info" class="tab_info"></p>
        <div id="my_orders">
          <p id="totals"></p>
          <div class="render_orders_row">
            <span id="cached_timestamp"></span>
            <button type="button" id="show_all" class="btn3" onclick="render_orders('server')" name="clear_data">Refresh</button>
          </div>
          <p id="all_data_info1"></p>
          <div id="local_orders">
            <table id="all_data_table" class="all_data_table">
              <caption><h3>Local Orders - <a id="local_csv">CSV</a></h3></caption>
                <tbody id="tbody_data_table" >
                </tbody>
            </table>
            <p class="local_orders_info">Local orders:</p>
            <div id="all_data_div1" class="all_data_div">
            </div>
          </div>

          <p id="all_data_info2"></p>
          <div id="gift_shipper_orders">
            <table id="gift_shipper_table" class="all_data_table">
              <caption><br><h3>Gift Shipper Orders - <a id="shipper_csv">CSV</a></h3></caption>
              <tbody id="tbody_gift_shipper"></tbody>
            </table>
            <hr>
            <p class="gift_shipper_info">Gift Shipper Orders:</p>
            <div id="all_data_div2" class="all_data_div">
            </div>
          </div>
        </div>
      </div>

      <div id="info_section" class="tabcontent">
        <p id="info_info" class="tab_info"></p>
      </div>

      <div id="popup" class="popup" style="display: none;">
        <button class="popup_button" onclick="toggle_modal()">Close</button>
        <div id="popup_content" class="popup_content">
        </div>
      </div>
      <div id="popup_overlay" class="popup_overlay" style="display: none;" onclick="toggle_modal()"></div>
      <div class="loader" id="loader"></div>
    </div>
  </body>

  <script>
    var API_KEY = 'AIzaSyBvmiDU5GtNFrqfFw4WgjyUg3_ef8TNmak';
    var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";
    var form_data;
    var announcement, title, scoutname, description, email_instructions, info_panel, multi_cust_inst, gas_link, id, 
      url_params, url_name, url_email, tracking_sheet;
    var local_catalog = [];
    var wreath_items = [];

    var wreath_list = '';
    var item_count = 2;
    var order_total = 0;
    var single_order = [];
    single_order[0] = [];
    var multi_order = [];

    var order = {};
    var local_orders = [];
    var gift_shipper_orders = [];

    var csvStr_local = "";
    var csvStr_ship = "";


    var curr_tab;

    var plus_circle = `
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
      </svg>
    `;

    var x_circle = `
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
      </svg>
      `;

    var add_single_wreath = `
      <div class="add_item">
       <div id="add_item_MMM" class="add_item_svg" onclick="add_wreath_item(this)"> ${plus_circle} </div>
       <div class="add_item_column">
          <div class="wreath_line">
            <div class="avoidwrap">
             <label for="wreath_name">Item:</label>
              <select id="wreath_item_MMM" class="wreath_item_select" name="wreath_item_MMM" onchange="wreath_item_change(this)">
                wreath_list
              </select>
              <label for="wreath_donation_MMM" id="wreath_donation_label_MMM" style="display:none;">Amount</label>
              <input id="wreath_donation_input_MMM" type="text" inputmode="decimal" name="wreath_donation_MMM" style="width: 3em; display:none;" 
                onInput="this.value = donation_amt(this.value)" onblur="donation_amt_blur(this)" placeholder="$">
            </div>

            <div class="avoidwrap">

              <span id="wreath_item_span_MMM" class="avoidwrap">
                <label for="wreath_amt">Quantity:</label>
                <select id="wreath_amt_MMM" name="wreath_amt_MMM" onchange="wreath_amount_change(this)">
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                </select>
              
                <div id="wreath_price_MMM" class="avoidwrap">nn</div>
                <div id="wreath_total_MMM" class="avoidwrap">Total: $0</div>
              </span>
            </div>
          </div>
        <div id="wreath_info_MMM" class="wreath_info">descr</div>
        <div id="wreath_info_small_MMM" class="wreath_info_small">
          <span id="info_click_MMM" class="clickable_span show_info_link" onclick="show_info(this)">[Info]</span>
          <span id="photo_click_MMM" style="" class="clickable_span" onclick="show_photo(this)">[Photo]</span>
        </div>
      </div>

    `;

    function handleClientLoad() {
      var queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      if (urlParams.get("id1") == undefined){
        document.getElementById("container").style.display = "none";
      }
      gapi.load('client', initClient);
    }

    function initClient() {
      var queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        if ((urlParams.get("id1"))){
          var scoutname_elem = document.getElementById('scoutname');
          var scout_email = document.getElementById('email_address');
          var other_name = document.getElementById('other_name');
          url_params = urlParams.get("email");
          id=urlParams.get("id1").replace("/", "");
          url_name = urlParams.get("scoutname") || "";
          url_name != "" ? url_name = url_name.replace(/[\.\_\-]/g, " ")
            .toLowerCase().replace(/(^\w{1})|(\s{1}\w{1})/g, match => match.toUpperCase()) : null;
          url_email = urlParams.get("email") || "";

          if (url_email != "") {
            var emailsArray3 = url_email.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi);
            if (emailsArray3 == null || emailsArray3.length == 0) {
              url_email = "";
            }
            else {
              scout_email.disabled = true;
            }
          }

          urlParams.get("scoutname") ? (scoutname_elem.disabled = true, other_name.disabled = true) : null;

          init_web_app();
        }
      }, function(error) {
        console.log(JSON.stringify(error, null, 2));
      });
    }

    function init_web_app(){
      var queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: urlParams.get("id1").split("/")[0],
        range: "'Webform Setup'!A2:J2",
      }).then(function(response){
        var range3 = response.result;
        populate_variables(range3.values);
        build_page(range3.values);
        get_catalog();
        //send_backend(range3.values);

      }, function(response) {
        console.log('Error: ' + response.result.error.message);
      });
    }

    function get_catalog(){
      var queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: urlParams.get("id1").split("/")[0],
        range: "'Local'!A2:F",
      }).then(function(response){
        var range4 = response.result;
        local_catalog = range4.values;
        //append a donation item to the catalog
        local_catalog.push(["yes", "Donation", "Use this item to take a donation", "$0", "", ""]);
      }).then(function(){
        local_catalog.forEach((item, i) => {
          item[0] == "yes" ? (wreath_list += '<option value="'+ i + '">' + item[1] + '</option>',
                wreath_items.push([item[1], item[3], item[2], item[4]]))
              : null;
        });
        document.getElementById("wreath_section").insertAdjacentHTML('beforeend',
          add_single_wreath.replace(/MMM/g, "1").replace(/wreath_list/g, wreath_list)
          .replace(/nn/g, wreath_items[0][1]).replace(/descr/g, wreath_items[0][2]));
        setTimeout(function(){
        // This hides the address bar:
          window.scrollTo(0, 25);
        }, 100);

        init_input_fields();
      }, function(response) {
        console.log('Error: ' + response.result.error.message);
      });
    }

    function add_wreath_item(elem){
      var MMM = elem.id.split("_")[2];

      document.getElementById("wreath_section").insertAdjacentHTML('beforeend',
        add_single_wreath.replace(/MMM/g, item_count++).replace(/wreath_list/g, wreath_list)
        .replace(/nn/g, wreath_items[0][1]).replace(/descr/g, wreath_items[0][2]));

      document.getElementById("add_item_"+MMM).style.visibility = 'hidden';
      window.scrollTo({ left: 0, top: document.body.scrollHeight, behavior: "smooth" })
    }

    function populate_variables(setup_data){
      var popup_elem = document.getElementById("popup_content");
      var cached_announcement = "";
      
      localStorage.getItem('cached_announcement') ? cached_announcement = localStorage.getItem('cached_announcement') : null;

      announcement = setup_data[0][0] || "";
      title = setup_data[0][1] || "";
      scoutname = setup_data[0][2] || "";
      description = setup_data[0][3] || "";
      email_instructions = setup_data[0][4] || "";
      info_panel = setup_data[0][5] || "";
      multi_cust_inst = setup_data[0][6] || "";
      my_orders_panel = setup_data[0][7] || "";
      gas_link = setup_data[0][8] || "";
      tracking_sheet = setup_data[0][9] || "";
      
      if (announcement != "" && hashCode(announcement) != cached_announcement){
        popup_elem.innerHTML = "<strong>Announcement!</strong><br><br>" + announcement;
        localStorage.setItem('cached_announcement', hashCode(announcement));
        toggle_modal();
      }

     //announcement == "no" ? (popup_elem.innerHTML = "The wreath sale is over!", toggle_modal()) : null;
      JSON.parse(localStorage.getItem('cached_orders')) ? local_orders = JSON.parse(localStorage.getItem('cached_orders')) : local_orders = [];

    }

    function hashCode(str) {
      return str.split('').reduce((prevHash, currVal) =>
        (((prevHash << 5) - prevHash) + currVal.charCodeAt(0))|0, 0);
    }

    function build_page(setup_data){
      document.getElementById("loader").style.display = "none";
      document.getElementById('webform_title').innerHTML = title;
      populate_scoutnames();
      document.getElementById('single_entry_info').innerHTML = description;
      //document.getElementById('multi_order_info').innerHTML = multi_cust_inst;
      document.getElementById('my_orders_info').innerHTML = my_orders_panel;
      document.getElementById('info_info').innerHTML = info_panel;
      document.getElementById('email_address').setAttribute('title', email_instructions);

      document.getElementById("enter_order_button").click();

    }

    function send_backend(){
      var timestamp = new Date();
      var curr_timestamp = timestamp.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });

      fetch(gas_link,
      {
        redirect: "follow",
        method: 'POST',
        headers: {
          'Accept': 'text/plain',
          'Content-Type': 'text/plain',
          },
        body: JSON.stringify(order)
      })
      .then((response) => {
        if (response.status >= 200 && response.status <= 299) {
          return response.json();
        } else {
          throw Error(response.statusText);
        }
      }).then((response) => {
        var popup_elem = document.getElementById("popup_content");
        popup_elem.innerHTML = "Success! Your order was sent.";
        document.getElementById("loader").style.display = "none";
        toggle_modal();
        clear_data();
      }).catch((error) =>{
        var popup_elem = document.getElementById("popup_content");
        document.getElementById("loader").style.display = "none";
        popup_elem.innerHTML = "An error occured while sending to the server <br> <br>" + error;
      });
    }

    function openTab(event, tab_name){
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tab_name).style.display = "block";
      event.currentTarget.className += " active";
      curr_tab = tab_name;
      tab_name == "my_orders_section" ? render_orders('cached') : null;
    }

    function container_click(){
      var other_name_elem = document.getElementById('other_name');
      var scoutname_elem = document.getElementById('scoutname');
      var scoutname = document.getElementById('scoutname').value;
      var other_name = document.getElementById("other_name").value;

      scoutname_elem.value == "Other" && other_name_elem.value != "" && curr_tab == "my_orders_section" ?
        show_orders() : null;

      scoutname == "Other" && other_name != "" ? (other_name = other_name.replace(/[\.\_\-]/g, " ")
          .toLowerCase().replace(/(^\w{1})|(\s{1}\w{1})/g, match => match.toUpperCase()),
          document.getElementById("other_name").value = other_name): null;
    }

    function populate_scoutnames(){
      var scoutname_elem = document.getElementById('scoutname');
      var scout_email = document.getElementById('email_address');
      var other_name = document.getElementById('other_name');
      var other_name_elem = document.getElementById("display_other_name");
      var name_match = "";
      scoutname_elem.innerHTML = "";
      scoutname_elem[scoutname_elem.length] = new Option("", "");
      scoutname = scoutname.replace(/, /g, ',') + ",Other";
      scoutname.split(',').forEach((item, i) => {
        scoutname_elem[scoutname_elem.length] = new Option(item, item);
        item.includes(url_name) && url_name != "" ? name_match = item : null;
      });

      url_email != "" ? scout_email.value = url_email : null;
      if (url_name != "") {
        //if (scoutname.includes(url_name)) {
        if(name_match != ""){
          scoutname_elem.value = name_match;
        }
        else {
          scoutname_elem.value = "Other";
          other_name_elem.style.display = "";
          other_name.value = url_name;
        }
      }
    }

    function toggle_name(elem){
      var other_name_elem = document.getElementById('display_other_name');
      var scoutname_elem = document.getElementById('scoutname');
      var tbody_data_table = document.getElementById("tbody_data_table");
      var all_data_div1 = document.getElementById("all_data_div1");
      var all_data_div2 = document.getElementById("all_data_div2");
      var my_orders = document.getElementById("my_orders");

      scoutname_elem.value == "Other" ? other_name_elem.style.display = "" :
          (other_name_elem.style.display = "none", document.getElementById("other_name").value="");
      curr_tab == "my_orders_section" ? render_orders("cached") : null;
    //  scoutname_elem.value == "Other" && curr_tab == "my_orders_section" ?
    //      (tbody_data_table.innerHTML = "", tbody_gift_shipper.innerHTML="", all_data_div1.innerHTML = "", 
    //        all_data_div2.innerHTML ="", my_orders.style.display = "none") : null;
    }

    function wreath_amount_change(elem){
      var wreath_index = document.getElementById("wreath_item_"+elem.id.split("_")[2]).value;
      var MMM = elem.id.split("_")[2];
      document.getElementById("wreath_total_" + MMM).innerHTML = "Total: $" +
        Number(document.getElementById("wreath_amt_" + MMM).value) * Number(local_catalog[wreath_index][3].split("$")[1]);

      Number(document.getElementById("wreath_amt_" + MMM).value) > 0 ?
      (single_order[Number(MMM)] = [wreath_index, document.getElementById("wreath_amt_" + MMM).value,
          local_catalog[wreath_index][3].split("$")[1], local_catalog[wreath_index][1]]) : null;

      Number(document.getElementById("wreath_amt_" + MMM).value) == 0 ?
        single_order[Number(MMM)] = [] : null;

      single_order_total();
    }

    function wreath_item_change(elem){
      var wreath_index = document.getElementById("wreath_item_"+elem.id.split("_")[2]).value;
      //console.log(local_catalog[wreath_index][1]);
      var MMM = elem.id.split("_")[2];
      document.getElementById("wreath_amt_" + elem.id.split("_")[2]).value = 0;
      document.getElementById("wreath_price_"+MMM).innerHTML = local_catalog[wreath_index][3];
      document.getElementById("wreath_total_" + MMM).innerHTML = "Total: $0";
      document.getElementById("wreath_info_" + MMM).innerHTML = local_catalog[wreath_index][2];

      if (local_catalog[wreath_index][1] == "Donation"){
        document.getElementById("wreath_item_span_" + MMM).style.display = "none";
        document.getElementById("photo_click_" + MMM).style.display = "none";
        document.getElementById("wreath_donation_label_" + MMM).style.display = "";
        document.getElementById("wreath_donation_input_" + MMM).style.display = "";
        document.getElementById("wreath_item_" + MMM).style.minWidth = "6em";
        document.getElementById("wreath_item_" + MMM).style.width = "10em";
      }
      else {
        document.getElementById("wreath_item_span_" + MMM).style.display = "";
        document.getElementById("photo_click_" + MMM).style.display = "";
        document.getElementById("wreath_donation_label_" + MMM).style.display = "none";
        document.getElementById("wreath_donation_input_" + MMM).style.display = "none";
        document.getElementById("wreath_item_" + MMM).style.minWidth = "15.5em";
        //document.getElementById("wreath_item_" + MMM).style.width = "10em";
      }

      single_order[Number(MMM)] = [];
      single_order_total();
    }

    function single_order_total(){
      order_total = 0;
      single_order.forEach((item, i) => {
        order_total += Number(item[1]) * Number(item[2]) || null;
      });
      document.getElementById("single_entry_total").innerHTML = "$" + order_total;
    }

    function toggle_checkbox(elem){
      var cust_cash =  document.getElementById("cust_cash");
      var cust_check =  document.getElementById("cust_check");
      var cust_venmo =  document.getElementById("cust_venmo");
      var cust_unpaid =  document.getElementById("cust_unpaid");

      if (elem == cust_unpaid && cust_unpaid.checked){
        cust_cash.checked = false;
        cust_check.checked = false;
        cust_venmo.checked = false;
      }

      if (cust_cash.checked || cust_check.checked || cust_venmo.checked){
        cust_unpaid.checked = false;
      }
    }

    function save_data(){
      var popup_elem = document.getElementById("popup_content");
      var scoutname = document.getElementById('scoutname').value;
      var other_name = document.getElementById("other_name").value;
      var cust_name = document.getElementById("cust_name").value;
      var cust_email = document.getElementById("cust_email").value;
      var cust_phone = document.getElementById("cust_phone").value;
      var cust_addr = document.getElementById("cust_addr").value;
      var email_address = document.getElementById("email_address").value;
      var cust_note = document.getElementById("cust_note").value;
      var error_msg = "";
      var cust_cash =  document.getElementById("cust_cash").checked;
      var cust_check =  document.getElementById("cust_check").checked;
      var cust_venmo =  document.getElementById("cust_venmo").checked;
      var cust_unpaid =  document.getElementById("cust_unpaid").checked;
      var cust_payment = "";

      var timestamp = new Date();
      var curr_timestamp = timestamp.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });

      if (cust_addr.split("GPS: ")[1]) {
        var coord = cust_addr.split("GPS: ")[1];
        var lat = coord.split(", ")[0];
        var long = coord.split(", ")[1];
        var map_link = "<a href='#link' target='_blank'>GPS: #text</a>";
        cust_addr = map_link.replace(/#link/g, "http://maps.google.com/maps?q="+lat+","+long).replace(/#text/g, lat+", "+long);
      }

      scoutname == "Other" && other_name != "" ? (other_name = other_name.replace(/[\.\_\-]/g, " ")
          .toLowerCase().replace(/(^\w{1})|(\s{1}\w{1})/g, match => match.toUpperCase()),
          document.getElementById("other_name").value = other_name): null;

      scoutname == "" ? error_msg += "The scout name cannot be blank!<br>" : null;
      scoutname == "Other" && other_name == "" ? error_msg += "The name field cannot be blank!<br>" : null;
      email_address == "" ? error_msg += "Your email address cannot be left blank! <br>" : null;

      if (email_address !="") {
        var emailsArray1 = email_address.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi);
        if (emailsArray1 == null || emailsArray1.length == 0) {
          error_msg += "Your email address is not valid. Please fix before submitting! <br>";
        }
      }

      if (cust_email !="") {
        var emailsArray2 = cust_email.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi);
        if (emailsArray2 == null || emailsArray2.length == 0) {
          error_msg += "Customer email address is not valid. Please fix before submitting! <br>";
        }
      }

      cust_name == "" ? error_msg += "The customer name cannot be blank!<br>" : null;
      error_msg == "" && order_total == 0 ? error_msg = "The total cannot be zero!" : null;

      error_msg != "" ? (popup_elem.innerHTML = error_msg, toggle_modal()) : null;

      if (error_msg == "") {
        var cust_contact = cust_name;
        cust_addr == "" ? null : cust_contact += ", " + cust_addr;
        cust_email == "" ? null : cust_contact += ". Email: " + cust_email;
        cust_phone == "" ? null : cust_contact += ". Phone: " + cust_phone;
        cust_cash ? cust_payment += " Cash" : null;
        cust_check ? cust_payment += " Check" : null;
        cust_venmo ? cust_payment += " Venmo" : null;
        cust_unpaid ? cust_payment += " Unpaid" : null;
        cust_cash || cust_check || cust_venmo || cust_unpaid ? cust_contact += " <br>**Payment:" + cust_payment : cust_contact += ".";

        var log_order = [];

        //remove empty slots (gaps) from the single_order array
        for (let i=0; i<single_order.length; i++){
          single_order[i] == null || single_order[i] == [] ? single_order[i] = [] : null;
        }

        single_order.forEach((item, i) => {
          if (item.length > 0) {
            if (item[3] == "Donation") {
              //take off the dolllar sign if any exists or set to zero
              log_order[Number(item[0])] ? log_order[Number(item[0])] = Number(log_order[Number(item[0])].replace(/\$/gi, "")) 
                : log_order[Number(item[0])] = 0;
              //add up multiple in the same order
              Number(item[1]) > 0 ? (log_order[Number(item[0])] += Number(item[2])) 
                || (log_order[Number(item[0])] = Number(item[2])) : null;
              //append dollar sign
              log_order[Number(item[0])] = "$" + log_order[Number(item[0])];
            }
            else {
              Number(item[1]) > 0 ? (log_order[Number(item[0])] += Number(item[1])) || (log_order[Number(item[0])] = Number(item[1])) : null;
            }
          }
        });

        var name = "";
        log_order.forEach((item, i) => {
          log_order[i] =log_order[i].toString();
        });

        scoutname == "Other" ? name = other_name : name = scoutname;

        log_order.unshift("$"+order_total);
        log_order.unshift(cust_note);
        log_order.unshift(cust_contact);
        log_order.unshift(name);
        log_order.unshift(curr_timestamp);

        order["scoutname"] = scoutname;
        order["other_name"] = other_name;
        order['name'] = name;
        order["cust_name"] = cust_name;
        order["cust_email"] = cust_email;
        order["cust_phone"] = cust_phone;
        order["cust_addr"] = cust_addr;
        order['cust_contact'] = cust_contact;
        order["email_address"] = email_address;
        order["order_total"] = "$" + order_total;
        order["single_order"] = single_order;
        order["log_order"] = log_order;
        order["id"] = id;
        order["curr_timestamp"] = curr_timestamp;
        order["cust_note"] = cust_note;
        order["tracking_sheet"] = tracking_sheet;

        /*
        single_order.forEach((item, i) => {
          item.length > 0 ? local_orders.push(single_order) : null;
        });
        */
        local_orders.push(log_order);
        localStorage.setItem('cached_orders', JSON.stringify(local_orders));
        //localStorage.setItem('cached_timestamp', JSON.stringify(curr_timestamp));
        document.getElementById("loader").style.display = "block";
        send_backend();
      }
    }

    function clear_data(){
      document.getElementById("wreath_section").innerHTML =
        add_single_wreath.replace(/MMM/g, "1").replace(/wreath_list/g, wreath_list)
          .replace(/nn/g, wreath_items[0][1]).replace(/descr/g, wreath_items[0][2]);
      init_input_fields();
      single_order = [];
      single_order[0] = [];
      single_order_total();
    }

    function toggle_modal(){
      var modal = document.getElementById("popup");
      var overlay = document.getElementById("popup_overlay");

      modal.style.display = modal.style.display == 'none' ? '' : 'none';
      overlay.style.display = overlay.style.display == 'none' ? '' : 'none';

    }

    function init_input_fields(){
      document.getElementById("cust_cash").checked = false;
      document.getElementById("cust_check").checked = false;
      document.getElementById("cust_venmo").checked = false;
      document.getElementById("cust_unpaid").checked = false;

      document.querySelectorAll('input').forEach( input => {
        if(input.id == "email_address" || input.id == "other_name") return;
        input.value = "";
      });



    }

    function show_info(elem){
      var popup_elem = document.getElementById("popup_content");
      var MMM = elem.id.split("_")[2];
      var wreath_index = document.getElementById("wreath_item_"+MMM).value;

      popup_elem.innerHTML = local_catalog[wreath_index][2];
      toggle_modal();
    }

    function show_photo(elem){
      var popup_elem = document.getElementById("popup_content");
      var MMM = elem.id.split("_")[2];
      var wreath_index = document.getElementById("wreath_item_"+MMM).value;
      var wreath_image_link = local_catalog[wreath_index][4];
      var width = document.body.clientWidth;

      width > 800 ? width = Math.round(width / 4) : width = Math.round(width * 0.7);

      //width = Math.round(width / 4);

      var url_split = wreath_image_link.split(/=[ws]/);

      var wreath_image_html = "<img id='' src='" + url_split[0] + "=w" + width + "-no?authuser=0 alt=' ' />";
      popup_elem.innerHTML = wreath_image_html;
      toggle_modal();

    }

    function show_email_info(){
      var popup_elem = document.getElementById("popup_content");
      popup_elem.innerHTML = email_instructions;
      toggle_modal();
    }

    function fetch_orders(){
      var timestamp = new Date();
      var curr_timestamp = timestamp.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: tracking_sheet,
        range: "'Webform'!A:Q",
      }).then(function(response){
        var range5 = response.result;
        local_orders = range5.values;
      }).then(function(){
        localStorage.setItem('cached_orders', JSON.stringify(local_orders));
        localStorage.setItem('cached_timestamp', curr_timestamp);
        fetch_gift_shipper();
      }, function(response) {
        console.log('Error: ' + response.result.error.message);
      });
    }

    function fetch_gift_shipper(){
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: tracking_sheet,
        range: "'Gift Shipper PayPal'!A:P",
      }).then(function(response){
        var range6 = response.result;
        gift_shipper_orders = range6.values;
      }).then(function(){
        localStorage.setItem('cached_gift_shipper', JSON.stringify(gift_shipper_orders));
        show_orders();
      }, function(response) {
        console.log('Error: ' + response.result.error.message);
      });
    }

    function render_orders(order_source){
      var popup_elem = document.getElementById("popup_content");
      var scoutname = document.getElementById('scoutname').value;
      var other_name = document.getElementById("other_name").value;
      var my_orders = document.getElementById("my_orders");
      var name = "";
      scoutname == "Other" ? name = other_name : name = scoutname;

      if (scoutname == "") {
        popup_elem.innerHTML = "Select a name above to get data!";
        my_orders.style.display = "none";
        toggle_modal();
        return;
      }
      else if (scoutname == "Other" && other_name == "") {
        popup_elem.innerHTML = "Enter any name above and then click anywhere in the document to see orders";
        my_orders.style.display = "none";
        toggle_modal();
        return;
      }

      if (order_source == "cached"){
        if (localStorage.getItem('cached_orders')) {
          show_orders();
        }
        else {
          fetch_orders();
        }
      }
      else {
        fetch_orders();
      }

    }

    function show_orders(){
      var scoutname = document.getElementById('scoutname').value;
      var other_name = document.getElementById("other_name").value;
      var cached_timestamp = document.getElementById('cached_timestamp');
      var all_data_info1 = document.getElementById("all_data_info1");
      var all_data_info2 = document.getElementById("all_data_info2");
      var all_data_div1 = document.getElementById("all_data_div1");
      var all_data_div2 = document.getElementById("all_data_div2"); 
      var all_data_table = document.getElementById("all_data_table");
      var local_csv_elem = document.getElementById("local_csv");
      var shipper_csv_elem = document.getElementById("shipper_csv");
      var totals = document.getElementById("totals");
      var my_orders = document.getElementById("my_orders");
      var gift_shipper_table = document.getElementById("gift_shipper_table");
      var local_orders_div = document.getElementById("local_orders");
      var gift_shipper_orders_div = document.getElementById("gift_shipper_orders");
      var popup_elem = document.getElementById("popup_content");
      var name = "";
      scoutname == "Other" ? name = other_name : name = scoutname;
      var wreath_orders = JSON.parse(localStorage.getItem('cached_orders')) || [];
      var gift_shipper_orders = JSON.parse(localStorage.getItem('cached_gift_shipper')) || [];
      //wreath_orders.length == 0 ? render_orders("server") : null;
      var table_head = "";
      var row_note = "";
      var table_line = "", table_row = "", order_divs_line = "";
      var gift_shipper_total = 0;
      var local_orders_total = 0;
      var all_totals = 0;
      var item_total = {};
      var count = 0;

      local_orders = JSON.parse(localStorage.getItem('cached_orders'));
      my_orders.style.display = "";

      var table_header = `
          <tr>hhhh</tr>
        `;
      var table_inner = `
        <tr>tttt</tr>
      `;

      var order_divs = `<div class=''>dddd</div>`;
      all_data_div1.innerHTML = "";
      all_data_div2.innerHTML = "";

      //fill each gap in the array (empty slots) with a zero

      wreath_orders.forEach((item, i) => {
        for (let i=0; i<wreath_orders[0].length; i++){
          item[i] == null || item[i] == "" ? item[i] = "0" : null;
          item[3] == "0" ? item[3] = "-" : null;
        }
      });

      wreath_orders[0].forEach((item, i) => {
        if (i == 1 || i == 3) return; //don't show scoutname or note in the table
        table_head += "<th>" + item + "</th>";
      });

      document.getElementById("tbody_data_table").innerHTML = table_header.replace(/hhhh/g, table_head);

      wreath_orders.forEach((item, i) => {
       if (item[1] == name) {
         local_orders_total += Number(item[4].split("$")[1]);
         table_line = "";
         row_note = "";
         item[3] != "-"  ? row_note = "Order Note: " + item[3] + "<br>" : row_note = "";
         //order_divs_line is for smaller screens
         order_divs_line += "<div class='order_divs'>" + "Timestamp: " + item[0] + "<br>" + "<div>Customer: "
            + item[2] + "</div><br>" + "Total: " + item[4] + "<br>" + row_note;
         item.forEach((item, i) => {
           i == 3 && item != "0" ? row_note = item : null;
           if (i == 1 || i == 3) return;
            if (row_note != "" && i == 2){
              table_line += "<td class='table_cell_note table_item_left' title='" + row_note.split('<br>')[0] 
                + "' onclick='note_popup(" + JSON.stringify(row_note) + ")'>" + item + "<div class='comment_div'></div></td>"; 
            }
            else if (i == 0 || i == 2){
              table_line += "<td class='table_item_left'>" + item + "</td>"; 
            }
            else {
              table_line += "<td>" + item + "</td>";
            }
          //item[item.length - 1] = item[item.length - 1].replace(/$/gi, "");
          if (i >= 5) {
            item = item.toString().replace(/\$/g, '');
            item_total[i] ? item_total[i] += Number(item) : item_total[i] = Number(item);
          }

         // row_note != "" && i == 2 ? table_line += "<td class='table_cell_note' title='" + row_note.split('<br>')[0] + "'>" + item + "<div class='comment_div'></div></td>"
         //     : table_line += "<td>" + item + "</td>";
         if (wreath_orders[0][i] != "Donation"){
          i > 3 && item > "0" ? order_divs_line += "Item: " + wreath_orders[0][i] + " / " + "Qty: " + item + "<br>" : null;
         }
         else {
          i > 3 && item > "0" ? order_divs_line += "Item: " + "Donation" + " / " + "Amount: $" + item + "<br>" : null;
         }
           //i > 3 && item > "0" ? order_divs_line += "Item: " + "Donation" + " / " + "Qty: " + item + "<br>" : null;
         });
         table_row += table_inner.replace(/tttt/g, table_line);
         order_divs_line += "</div>";
       }
       row_note = "";
     });

     table_line = "<td></td><td class='totals_class'><strong>TOTALS</strong></td><td class='totals_class'><strong>$" 
        + local_orders_total + "</strong></td>";
     for (const property in item_total) {
      count++;
      if (count == Object.keys(item_total).length) {
        table_line += "<td class='totals_class'> <strong>$" + item_total[property] + "</strong> </td>";

      }
      else {
        table_line += "<td class='totals_class'> <strong>" + item_total[property] + "</strong> </td>";

      }
     }
     table_row += table_inner.replace(/tttt/g, table_line);


    //build the CSV data
     csvStr_local = "";
     wreath_orders.forEach((item, i) => {
      if (item[1] == "Name" || item[1] == name) {
        if (i==0) {item.splice(3,0,"Customer Email");}
        if (i!=0) {
          //split off cust email into its own column and remove it from the cust info column
          if (item[2].includes('Email:')){
            var addr = item[2].match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)/g) || [""];
            item.splice(3,0,addr[0]);            
            item[2] = item[2].replace(/Email:\s([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)(\.\s)?/g, "");
          }
          else {
            item.splice(3,0,"");
          }
        }
        csvStr_local += '"' + item.map(item1 => item1.toString().replace(/<.*?[>]/g,'').replace(/[#]/g, "")).join('","') + '"\n';
      }
     });

      if (local_orders_total == 0 && name != "") {
        all_data_info1.innerHTML = "**** No local order data for " + name;
        document.getElementById("tbody_data_table").innerHTML = "";
        all_data_div1.innerHTML = "";
        local_orders_div.style.display = "none";
      }
      else {
        all_data_info1.innerHTML = "";
        local_orders_div.style.display = "";
      }

      name == "" ? document.getElementById("tbody_data_table").innerHTML = "" : null;
      all_data_div1.insertAdjacentHTML('beforeend', order_divs.replace(/dddd/g, order_divs_line));

      document.getElementById("tbody_data_table").insertAdjacentHTML('beforeend', table_row);
      localStorage.getItem('cached_timestamp') ? cached_timestamp.innerHTML = "Last refresh from server: " + 
        localStorage.getItem('cached_timestamp')
            : null;

      //Handle Gift Shipper table
      table_line = "", table_row = "", order_divs_line = "", table_head = "", div_text = "";
      
      if (gift_shipper_orders){
        var table_column_names = ["Timestamp", "Buyer", "Recipient", "Wreath", "qty", "Cost", "Msg"];
        table_column_names.forEach((item, i) => {
          table_head += "<th>" + item + "</th>";
        });
      }
      if (name == "") {
        document.getElementById("tbody_gift_shipper").innerHTML = ""; 
        return;
      }
      else {
        document.getElementById("tbody_gift_shipper").innerHTML = table_header.replace(/hhhh/g, table_head);
      }
      
      gift_shipper_orders.slice(1).forEach((item, i) => {
        var order_timestamp = item[0];
        var scout_credit = item[1];
        var buyer = item[2];
        var recipient = item[5] + ": " + item[6] + ", " + item[7] + ", " + item[8] + item[9];
        var wreath_item = item[10];
        var qty = item[11];
        var price = item[13];
        var msg = item[14];
        var div_text = "";
        var td_map = [order_timestamp, buyer, recipient, wreath_item, qty, price, msg];
        name == scout_credit ? gift_shipper_total += Number(qty) * Number(price.split("$")[1]) : null;
        if (item[1] == name) {
          td_map.forEach((item, i) => {
            i == 4 || i == 5 ? table_line += "<td>" + item + "</td>" : 
              table_line += "<td class=''>" + item + "</td>"; 
          });
          div_text += "<div class='order_divs'>" + "Timestamp: " + order_timestamp + "<br>" + "Buyer: " + buyer + "<br>" + "Recipient: "
              + recipient + "<br>" + "Item: " + wreath_item + " / " + "Qty: " + qty + "<br>" + "Price: " + price + "<br>"
              + "Gift Msg: " + msg;
          
            document.getElementById("tbody_gift_shipper").insertAdjacentHTML('beforeend', table_inner.replace(/tttt/g, table_line));
            all_data_div2.insertAdjacentHTML('beforeend', div_text);
        }
        table_line = "";
        div_text = "";
      });

    //build the CSV data
      csvStr_ship = "";
      gift_shipper_orders.forEach((item, i) => {
      if (item[1] == "Scout/Org" || item[1] == name) {
        csvStr_ship += '"' + item.map(item1 => item1.replace('#','num')).map(item1 => item1.replace(/[\r\n]+/g,' ')).join('","') + '"\n';
      }
     });


      if (gift_shipper_total == 0 && name != "") {
        all_data_info2.innerHTML = "**** No Gift Shipper order data for " + name;
        document.getElementById("tbody_gift_shipper").innerHTML = "";
        all_data_div2.innerHTML = "";
        gift_shipper_orders_div.style.display = "none";
      }
      else {
        all_data_info2.innerHTML = "";
        gift_shipper_orders_div.style.display = "";
      }

      totals.innerHTML = "Below are the orders for <strong>" + name + "</strong><br>" + "Order Totals: " + "$" + 
        (local_orders_total + gift_shipper_total) + " (Local: $" + local_orders_total + ", Gift Shipper: $" + 
        gift_shipper_total + ")";
      
      local_csv_elem.href = 'data:text/csv;charset=utf-8,' + encodeURI(csvStr_local);
      local_csv_elem.target = "_blank";
      local_csv_elem.download = name+"_local_orders.csv";
      shipper_csv_elem.href = 'data:text/csv;charset=utf-8,' + encodeURI(csvStr_ship);
      shipper_csv_elem.target = "_blank";
      shipper_csv_elem.download = name+"_gift_shipper_orders.csv";


    }

    function note_popup(note_msg){
      var popup_elem = document.getElementById("popup_content");
      popup_elem.innerHTML = note_msg;
      toggle_modal();
    }

    function phoneFormat(input) {//returns (###) ###-####
      input = input.replace(/\D/g,'');
      var size = input.length;
      if (size>0) {input="("+input}
      if (size>3) {input=input.slice(0,4)+") "+input.slice(4,11)}
      if (size>6) {input=input.slice(0,9)+"-" +input.slice(9)}
      return input;
    }

    function donation_amt(input) {//returns $nn
      input = input.replace(/\D/g,'');
      var size = input.length;
      if (size>0) {input="$"+input};
      return input;
    }

    function donation_amt_blur(elem){
      var wreath_index = document.getElementById("wreath_item_"+elem.id.split("_")[3]).value;
      var MMM = elem.id.split("_")[3];
      single_order[Number(MMM)] = [wreath_index, "1", elem.value.split("$")[1], local_catalog[wreath_index][1]];
      single_order_total();
    }
    
    function paid_button(){
      document.getElementById("cust_note").value = "Paid in full";
    }

    function geo_loc(){
      var input_elem = document.getElementById("cust_addr");
      var popup_elem = document.getElementById("popup_content");

      if(!navigator.geolocation) {
        //status.textContent = 'Geolocation is not supported by your browser';
        console.log("not supported by browser");
      }
      else {
        navigator.geolocation.getCurrentPosition(success, error);
      }

      function success(position){
        const latitude  = position.coords.latitude;
        const longitude = position.coords.longitude;
        input_elem.value = "GPS: " + latitude.toFixed(5) + ", " + longitude.toFixed(5);

      }

      function error(){
        popup_elem.innerHTML = "Geolocation is not supported by your browser!";
        toggle_modal();
      }

    }

  </script>
  <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
</html>
